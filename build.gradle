plugins {
    id 'java'
    // ğŸ”¹ run íƒœìŠ¤í¬ì™€ jpackageì— í•„ìš”í•œ application í”ŒëŸ¬ê·¸ì¸
    id 'application'
    // ğŸ”¹ ëª¨ë“ˆ ê´€ë ¨ ë³´ì¡° í”ŒëŸ¬ê·¸ì¸
    id 'org.javamodularity.moduleplugin' version '1.8.12'
    // ğŸ”¹ jlink / jpackage í”ŒëŸ¬ê·¸ì¸
    id 'org.beryx.jlink' version '2.26.0'
}

group = 'dbps'
version = '1.0.0'

repositories {
    mavenCentral()
}
sourceSets {
    main {
        resources {
            srcDirs = ['src/main/resources']
        }
    }
}
java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
    modularity.inferModulePath = true // ìë™ ëª¨ë“ˆ ê°ì§€
}

// -----------------------------------
// application í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
// -----------------------------------
application {
    // ğŸ”¹ ëª¨ë“ˆ ì´ë¦„ & ë©”ì¸ í´ë˜ìŠ¤ ì§€ì •
    //    module-info.javaì— ì„ ì–¸ëœ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    mainModule = 'DBPS.main'
    mainClass = 'dbps.dbps.Simulator'
}

// -----------------------------------
// ì˜ì¡´ì„± ì„¤ì •
// -----------------------------------
def jfxVer = '17.0.14'
dependencies {
    // JavaFX (Windows 64ë¹„íŠ¸)
    implementation "org.openjfx:javafx-base:${jfxVer}:win"
    implementation "org.openjfx:javafx-graphics:${jfxVer}:win"
    implementation "org.openjfx:javafx-controls:${jfxVer}:win"
    implementation "org.openjfx:javafx-fxml:${jfxVer}:win"

    // RichTextFX
    implementation 'org.fxmisc.richtext:richtextfx:0.11.3'

    // Jackson
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'

    // jSerialComm
    implementation 'com.fazecast:jSerialComm:2.11.0'

    // Lombok
    compileOnly 'org.projectlombok:lombok:1.18.36'
    annotationProcessor 'org.projectlombok:lombok:1.18.36'

    // SLF4J
    implementation 'org.slf4j:slf4j-api:2.0.16'
    implementation 'org.slf4j:slf4j-simple:2.0.16'

    // Paho MQTT
    implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.2.5'
}

// UTF-8 ì»´íŒŒì¼ ì˜µì…˜
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// -----------------------------------
// run íƒœìŠ¤í¬ë¥¼ ëª¨ë“ˆ ë°©ì‹ìœ¼ë¡œ ì¬ì •ì˜
// -----------------------------------
tasks.named("run", JavaExec).configure {
    // (1) Gradle ê¸°ë³¸ classpath ì œê±° -> ëª¨ë“ˆ íŒ¨ìŠ¤ë§Œ ì‚¬ìš©
    classpath = files()

    // (2) ë¹Œë“œëœ í´ë˜ìŠ¤ + ëŸ°íƒ€ì„ ì˜ì¡´ì„± JAR ê²½ë¡œ
    def mainOutput = sourceSets.main.output.classesDirs.asPath
    def runtimeDeps = configurations.runtimeClasspath.asPath
    def modulePath = mainOutput + File.pathSeparator + runtimeDeps

    // (3) jvmArgsë¡œ ëª¨ë“ˆ ì‹¤í–‰ ì˜µì…˜ ì§€ì •
    jvmArgs = [
            "--module-path", modulePath,
            "--add-modules", "ALL-MODULE-PATH",
            // --module <ëª¨ë“ˆëª…>/<ë©”ì¸í´ë˜ìŠ¤(íŒ¨í‚¤ì§€í¬í•¨)>
            "--module", "DBPS.main/dbps.dbps.Simulator"
    ]

    // ğŸ”¹ "No main class specified" ë°©ì§€ìš©
    mainClass.set("dbps.dbps.Simulator")
}

// -----------------------------------
// jlink + jpackage => Windows EXE
// -----------------------------------
jlink {
    options = [
            '--strip-debug',
            '--compress', '2',
            '--no-header-files',
            '--no-man-pages'
    ]
    mergedModule {
        enabled = true
    }
    addExtraDependencies("javafx")
    addExtraDependencies("automatic")

    launcher {
        // exe ë“±ì—ì„œ ì‚¬ìš©í•  ì‹¤í–‰íŒŒì¼ ì´ë¦„
        name = 'dbProtocolSimulator'
    }

    jpackage {
        imageName = 'dbProtocolSimulator'
        installerName = 'dbProtocolSimulator'
        installerType = 'exe'
        icon = 'src/main/resources/icon.ico'
        installerOptions = [
                '--win-menu',
                '--win-shortcut'
        ]
        jvmArgs = [
                '--enable-preview'
        ]
    }
}
tasks.named("prepareMergedJarsDir") {
    doNotTrackState("Disabling state tracking due to non-regular files in merged jars")
}
